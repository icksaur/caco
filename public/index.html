<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caco</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="highlight-dark.min.css">
  <script src="marked.min.js"></script>
  <script src="mermaid.min.js"></script>
  <script src="highlight.min.js"></script>
  <script src="purify.min.js"></script>
</head>
<body>
  <!--
    ==========================================================================
    VIEW STATE: All view visibility changes MUST go through view-controller.ts
    Do NOT manually toggle .active/.hidden classes on views.
    Use: setViewState('sessions' | 'newChat' | 'chatting' | 'applet')
    ==========================================================================
  -->

  <!-- Floating menu button (top-left, always visible) -->
  <button type="button" id="menuBtn" class="menu-btn" onclick="toggleSessions()" aria-label="Toggle sessions">
    <span></span>
    <span></span>
    <span></span>
    <span id="unobservedBadge" class="unobserved-count-badge hidden"></span>
    <span id="menuBusyIndicator" class="menu-busy-indicator hidden"></span>
  </button>

  <!-- Applet toggle button (top-right, always visible except during sessions) -->
  <!-- Click: toggle applet, Long-press (1s): open applet browser -->
  <button type="button" id="appletBtn" class="applet-btn" aria-label="Toggle applet">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Expand button (next to applet button, visible when applet panel is open) -->
  <button type="button" id="expandBtn" class="expand-btn hidden" aria-label="Toggle full width">
    <span class="expand-icon">Â«</span>
  </button>

  <!-- Session manager view (full-screen overlay, outside main for proper stacking) -->
  <div id="sessionView" class="session-overlay">
    <div class="session-content">
      <div id="usageInfo" class="usage-info"></div>
      
      <!-- Search + Action row (4:1 ratio) -->
      <div class="session-top-row">
        <input type="text" id="sessionSearchInput" class="session-search-input" placeholder="Search sessions..." autocomplete="off">
        <button type="button" id="actionBtn" class="new-session-btn" onclick="actionBtnClick()">+ New session</button>
      </div>
      
      <!-- Schedules section -->
      <div id="schedulesSection" class="schedules-section">
        <div class="section-header">schedules</div>
        <div id="schedulesList" class="schedules-list"></div>
      </div>
      
      <div id="sessionList"></div>
    </div>
  </div>

  <main>
    <!-- Work area: chat and applet side-by-side on desktop -->
    <div class="work-area">
      <!-- Chat panel (left on desktop, main on mobile) -->
      <div id="chatPanel" class="chat-panel">
        <div id="chatScroll" class="chat-scroll">
          <div id="chatView" class="chat-view">
            <!-- New chat form (shown when no messages) -->
            <div id="newChat" class="new-chat">
              <h2>New Chat</h2>
              <div class="new-chat-cwd">
                <label for="newChatCwd">Working directory</label>
                <input type="text" id="newChatCwd" placeholder="/path/to/project">
              </div>
              <h3>Select a model</h3>
              <div id="modelList"></div>
              <div id="newChatError" class="new-chat-error"></div>
            </div>
            <!-- Chat messages (shown when has messages) -->
            <div id="chat" class="hidden">
              <!-- Messages will appear here -->
            </div>
            <!-- Working cursor (shown during streaming) -->
            <div id="workingCursor" class="streaming-cursor hidden"></div>
          </div>
        </div>

        <!-- Footer with chat input (inside chat panel) -->
        <footer id="chatFooter">
          <div id="imagePreview" class="image-preview">
            <img id="previewImg" src="" alt="Pasted image">
            <span>Image attached</span>
            <button type="button" class="remove-btn" onclick="removeImage()">Ã— Remove</button>
          </div>
          <form id="chatForm">
            <input type="hidden" id="imageData" name="imageData">
            <input type="hidden" id="selectedModel" name="model" value="claude-sonnet-4">
            <div class="input-bar">
              <textarea 
                class="input-text"
                name="message" 
                placeholder="Ask anything..." 
                required
                autofocus
                rows="1"
              ></textarea>
              <button type="submit" class="send-btn">Send</button>
              <button type="button" class="stop-btn" onclick="stopStreaming()">Stop</button>
            </div>
          </form>
          <div id="contextFooter" class="context-footer nohighlight" data-context-footer="true">
            <span class="context-icon">ðŸ“Ž</span>
            <span class="context-links"></span>
          </div>
        </footer>
      </div>

      <!-- Applet panel (right on desktop, toggled on mobile) -->
      <div id="appletPanel" class="applet-panel hidden">
        <div id="appletView" data-applet-view="true">
          <!-- .applet-instance divs are created dynamically by applet-runtime -->
        </div>
      </div>
    </div>
  </main>

  <!-- Toast notifications (floats above all content) -->
  <div id="toast" class="toast hidden" role="alert">
    <span class="toast-message"></span>
    <button type="button" class="toast-close" onclick="hideToast()" aria-label="Close">Ã—</button>
  </div>

  <script type="module" src="bundle.js"></script>
</body>
</html>
