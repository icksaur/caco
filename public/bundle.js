function D(){document.addEventListener("paste",e=>{let t=e.clipboardData?.items;if(t)for(let o=0;o<t.length;o++){let n=t[o];if(n.type.indexOf("image")!==-1){e.preventDefault();let s=n.getAsFile();if(!s)continue;let a=new FileReader;a.onload=i=>{let c=i.target?.result,l=document.getElementById("imageData"),r=document.getElementById("previewImg"),d=document.getElementById("imagePreview");l&&(l.value=c),r&&(r.src=c),d&&d.classList.add("visible")},a.onerror=i=>console.error("FileReader error:",i),a.readAsDataURL(s);break}}})}function v(){let e=document.getElementById("imageData"),t=document.getElementById("previewImg"),o=document.getElementById("imagePreview");e&&(e.value=""),t&&(t.src=""),o&&o.classList.remove("visible")}function m(){let e=document.querySelector("main");e&&(e.scrollTop=e.scrollHeight)}function B(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>t[o])}function N(e){if(!e)return"";let t=Date.now(),o=new Date(e).getTime(),n=t-o,s=Math.floor(n/6e4),a=Math.floor(n/36e5),i=Math.floor(n/864e5),c=Math.floor(i/7),l=Math.floor(i/30),r=Math.floor(i/365);return r>=1?`${r} year${r>1?"s":""}`:l>=1?`${l} month${l>1?"s":""}`:c>=1?`${c} week${c>1?"s":""}`:i>=1?`${i} day${i>1?"s":""}`:a>=1?`${a} hour${a>1?"s":""}`:s>=1?`${s} min`:"just now"}var y=[{id:"claude-sonnet-4",name:"Claude Sonnet 4",cost:1},{id:"claude-sonnet-4.5",name:"Claude Sonnet 4.5",cost:1},{id:"claude-opus-4.5",name:"Claude Opus 4.5",cost:3},{id:"claude-haiku-4.5",name:"Claude Haiku 4.5",cost:.33},{id:"gpt-4.1",name:"GPT-4.1",cost:0},{id:"gpt-4o",name:"GPT-4o",cost:0},{id:"gpt-5-mini",name:"GPT-5 mini",cost:0},{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",cost:1},{id:"gemini-3-flash-preview",name:"Gemini 3 Flash",cost:.33}],g="claude-sonnet-4";function L(){let e=document.getElementById("modelDropdown"),t=document.querySelector(".hamburger-btn.model-btn");if(!e)return;e.classList.contains("visible")?(e.classList.remove("visible"),t?.classList.remove("active")):(e.classList.add("visible"),t?.classList.add("active"),S())}function P(){document.addEventListener("click",e=>{let t=document.getElementById("modelDropdown"),o=document.querySelector(".hamburger-btn.model-btn");t&&o&&!t.contains(e.target)&&!o.contains(e.target)&&(t.classList.remove("visible"),o.classList.remove("active"))})}function S(){let e=document.getElementById("modelList");if(e){e.innerHTML="";for(let t of y){let o=document.createElement("div");o.className="model-item",t.id===g&&o.classList.add("active"),o.dataset.modelId=t.id,o.onclick=()=>M(t.id);let n=document.createElement("span");n.className="model-name",n.textContent=t.name,o.appendChild(n);let s=document.createElement("span");s.className="model-cost",t.cost===0?(s.textContent="free",s.classList.add("free")):t.cost<1?(s.textContent=`${t.cost}x`,s.classList.add("cheap")):t.cost>1?(s.textContent=`${t.cost}x`,s.classList.add("expensive")):s.textContent="1x",o.appendChild(s),e.appendChild(o)}}}function M(e){g=e;let t=document.getElementById("selectedModel");t&&(t.value=e);let o=y.find(s=>s.id===e),n=document.querySelector('input[name="message"]');n&&o&&(n.placeholder=`Ask ${o.name}...`),fetch("/api/preferences",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lastModel:e})}).catch(()=>{}),L()}function k(e){if(e.lastModel&&y.find(t=>t.id===e.lastModel)){g=e.lastModel;let t=document.getElementById("selectedModel");t&&(t.value=g);let o=y.find(s=>s.id===g),n=document.querySelector('input[name="message"]');n&&o&&(n.placeholder=`Ask ${o.name}...`)}}var x="",H=null;function O(e){x=e}function C(){let e=document.getElementById("chat"),t=document.getElementById("sessionPanel"),o=document.getElementById("modelPanel"),n=document.querySelector(".hamburger-btn:not(.model-btn)"),s=document.querySelector(".hamburger-btn.model-btn");if(!t||!e)return;t.classList.contains("visible")?(t.classList.remove("visible"),e.classList.remove("hidden"),n?.classList.remove("active")):(o?.classList.remove("visible"),s?.classList.remove("active"),t.classList.add("visible"),e.classList.add("hidden"),n?.classList.add("active"),A())}async function A(){try{let e=await fetch("/api/sessions");if(!e.ok)return;let t=await e.json(),{activeSessionId:o,currentCwd:n,grouped:s}=t;x=n,H=o;let a=document.getElementById("sessionList");if(!a)return;a.innerHTML="";let i=Object.keys(s).sort((c,l)=>c===n?-1:l===n?1:c.localeCompare(l));for(let c of i){let l=s[c];if(c==="(unknown)"||!c){let d=document.createElement("div");d.className="cwd-header omitted",d.textContent=`no cwd (${l.length} omitted)`,a.appendChild(d);continue}let r=document.createElement("div");r.className="cwd-header",r.textContent=c===n?`${c} (current)`:c,a.appendChild(r);for(let d of l){let u=K(d,o);a.appendChild(u)}}}catch(e){console.error("Failed to load sessions:",e)}}function K(e,t){let o=document.createElement("div");o.className="session-item",e.sessionId===t&&o.classList.add("active"),o.dataset.sessionId=e.sessionId;let n=document.createElement("span");n.className="session-summary";let s=e.summary||"No summary",a=e.updatedAt?` (${N(e.updatedAt)})`:"";n.textContent=s+a,n.onclick=()=>I(e.sessionId),o.appendChild(n);let i=document.createElement("button");return i.className="session-delete",i.textContent="\xD7",i.onclick=c=>{c.stopPropagation(),b(e.sessionId,e.summary)},o.appendChild(i),o}async function I(e){if(e===H){C(),m();return}let t=document.querySelector(`.session-item[data-session-id="${e}"]`);t&&t.classList.add("loading");try{let o=await fetch(`/api/sessions/${e}/resume`,{method:"POST"});if(o.ok)window.location.reload();else{let n=await o.json();t&&t.classList.remove("loading"),alert("Failed to switch session: "+n.error)}}catch(o){console.error("Failed to switch session:",o),t&&t.classList.remove("loading")}}async function b(e,t){let o=t||e.slice(0,8);if(confirm(`Delete session "${o}"?

This cannot be undone.`))try{let n=await fetch(`/api/sessions/${e}`,{method:"DELETE"});if(n.ok){if((await n.json()).wasActive){let a=document.getElementById("chat");a&&(a.innerHTML="")}A()}else{let s=await n.json();alert("Failed to delete session: "+s.error)}}catch(n){console.error("Failed to delete session:",n),alert("Failed to delete session: "+n.message)}}function F(){let e=document.getElementById("newChatForm"),t=document.getElementById("newChatPath"),o=document.getElementById("newChatError");!e||!t||(e.classList.contains("expanded")?(e.classList.remove("expanded"),o&&(o.classList.remove("visible"),o.textContent="")):(e.classList.add("expanded"),t.value=x,t.focus(),t.select()))}async function q(){let e=document.getElementById("newChatPath"),t=document.getElementById("newChatError"),o=e?.value.trim();if(!o){t&&(t.textContent="Please enter a working directory path",t.classList.add("visible"));return}try{let n=await fetch("/api/sessions/new",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cwd:o})});if(n.ok)window.location.reload();else{let s=await n.json();t&&(t.textContent=s.error||"Failed to create session",t.classList.add("visible"))}}catch(n){console.error("Failed to create session:",n),t&&(t.textContent="Failed to create session: "+n.message,t.classList.add("visible"))}}async function j(){try{let e=await fetch("/api/history");if(e.ok){let t=await e.text(),o=document.getElementById("chat");o&&t.trim()&&(o.innerHTML=t,typeof window.renderMarkdown=="function"&&window.renderMarkdown()),m()}}catch(e){console.error("Failed to load history:",e)}}async function R(){try{let e=await fetch("/api/preferences");if(e.ok){let t=await e.json();k(t),t.lastCwd&&O(t.lastCwd)}}catch(e){console.error("Failed to load preferences:",e)}}function p(e,t,o=null){let n=document.querySelector("#pending-response .activity-box");if(!n)return;let s=document.createElement("div");if(s.className=`activity-item ${e}`,o){let i=document.createElement("div");i.className="activity-summary",i.textContent=t,i.onclick=()=>s.classList.toggle("expanded"),s.appendChild(i);let c=document.createElement("div");c.className="activity-details",c.textContent=o,s.appendChild(c)}else s.textContent=t;n.appendChild(s);let a=n.closest(".activity-wrapper");if(a){let i=n.querySelectorAll(".activity-item").length,c=a.querySelector(".activity-count");c&&(c.textContent=`(${i})`)}n.scrollTop=n.scrollHeight}function J(e){let t=e.closest(".activity-wrapper");if(!t)return;let o=t.classList.contains("collapsed");t.classList.toggle("collapsed");let n=e.querySelector(".activity-icon");n&&(n.textContent=o?"\u25BC":"\u25B6")}function _(e){if(!e)return"";let t=[];for(let[o,n]of Object.entries(e))if(typeof n=="string"){let s=n.length>80?n.substring(0,80)+"...":n;t.push(`${o}: ${s}`)}else typeof n=="object"?t.push(`${o}: ${JSON.stringify(n).substring(0,60)}...`):t.push(`${o}: ${n}`);return t.join(", ")}function G(e){if(!e)return"";if(e.content){let t=typeof e.content=="string"?e.content:JSON.stringify(e.content);return t.length>500?t.substring(0,500)+"...":t}return JSON.stringify(e).substring(0,200)}async function U(e){if(!e||!e.id)return;let t=document.querySelector("#pending-response .outputs-container");if(t)try{let o=await fetch(`/api/outputs/${e.id}?format=json`);if(!o.ok)return;let{data:n,metadata:s}=await o.json(),a="";if(e.type==="file"){let i=s.highlight||"",c=s.path?`**${s.path}**`:"",l=s.startLine&&s.endLine?` (lines ${s.startLine}-${s.endLine} of ${s.totalLines})`:"";a=`${c}${l}

\`\`\`${i}
${n}
\`\`\``}else if(e.type==="terminal"){let i=s.exitCode===0?"":` (exit ${s.exitCode})`;a=`\`\`\`bash
$ ${s.command}${i}
${n}
\`\`\``}else if(e.type==="image"){let i=document.createElement("img");i.className="output-image",i.src=s.mimeType&&typeof n=="string"?`data:${s.mimeType};base64,${n}`:`/api/outputs/${e.id}`,i.alt=s.path||"Image",t.appendChild(i);return}if(a&&window.marked&&window.DOMPurify){let i=document.createElement("div");i.className="output-content",i.innerHTML=window.DOMPurify.sanitize(window.marked.parse(a)),t.appendChild(i),i.querySelectorAll("pre code").forEach(c=>{window.hljs&&window.hljs.highlightElement(c)})}}catch(o){console.error("Error displaying output:",o)}}var f=null,w=null;function Q(e,t){let o=document.getElementById("chat");if(!o)throw new Error("Chat element not found");let n=document.createElement("div");n.className="message user",n.innerHTML=`${B(e)}${t?' <span class="image-indicator">[img]</span>':""}`,o.appendChild(n);let s=document.createElement("div");return s.className="message assistant pending",s.id="pending-response",s.setAttribute("data-markdown",""),s.innerHTML=`
    <div class="activity-wrapper">
      <div class="activity-header" onclick="toggleActivityBox(this)">
        <span class="activity-icon">\u25B6</span>
        <span class="activity-label">Activity</span>
        <span class="activity-count"></span>
      </div>
      <div class="activity-box"></div>
    </div>
    <div class="outputs-container"></div>
    <div class="markdown-content streaming-cursor"></div>
  `,o.appendChild(s),m(),s}function V(e,t,o){let n=new URLSearchParams({prompt:e,model:t});o&&n.set("imageData",o);let s=new EventSource(`/api/stream?${n.toString()}`);f=s;let a=document.querySelector("#pending-response .markdown-content"),i="",c=!1;s.addEventListener("assistant.message_delta",l=>{let r=JSON.parse(l.data);if(r.deltaContent){if(i+=r.deltaContent,a&&(a.textContent=i),!c){let d=document.querySelector("#pending-response .activity-wrapper");if(d){d.classList.add("collapsed");let u=d.querySelector(".activity-icon");u&&(u.textContent="\u25B6")}c=!0}m()}}),s.addEventListener("assistant.message",l=>{let r=JSON.parse(l.data);if(r.content&&a){a.textContent=r.content,a.classList.remove("streaming-cursor");let d=document.getElementById("pending-response");d&&(d.dataset.markdownProcessed="false"),typeof window.renderMarkdown=="function"&&window.renderMarkdown()}}),s.addEventListener("assistant.turn_start",l=>{let r=JSON.parse(l.data);p("turn",`Turn ${parseInt(r.turnId||0)+1}...`)}),s.addEventListener("assistant.intent",l=>{let r=JSON.parse(l.data);r.intent&&p("intent",`Intent: ${r.intent}`)}),s.addEventListener("tool.execution_start",l=>{let r=JSON.parse(l.data),d=r.toolName||r.name||"tool",u=_(r.arguments),h=`\u25B6 ${d}`,E=u?`Arguments: ${u}`:null;p("tool",h,E)}),s.addEventListener("tool.execution_complete",l=>{let r=JSON.parse(l.data),d=r.toolName||r.name||"tool",h=`${r.success?"\u2713":"\u2717"} ${d}`,E=r.result?G(r.result):null;p("tool-result",h,E),r._output&&U(r._output)}),s.addEventListener("session.error",l=>{let r=JSON.parse(l.data);p("error",`Error: ${r.message||"Unknown error"}`)}),s.addEventListener("error",l=>{let r=JSON.parse(l.data||"{}");p("error",`Error: ${r.message||"Connection error"}`)}),s.addEventListener("done",()=>{s.close(),f=null,T()}),s.addEventListener("session.idle",()=>{}),s.onerror=l=>{console.error("EventSource error:",l),s.close(),f=null,!i&&!c&&p("error","Connection lost"),T()}}function $(){if(f){f.close(),f=null,p("info","Stopped by user");let e=document.querySelector("#pending-response .markdown-content");e&&e.classList.remove("streaming-cursor"),T()}}function T(){let e=document.getElementById("pending-response");if(e){e.classList.remove("pending"),e.removeAttribute("id");let t=e.querySelector(".markdown-content");t&&t.classList.remove("streaming-cursor");let o=e.querySelector(".activity-wrapper");if(o){o.classList.add("collapsed");let n=o.querySelector(".activity-icon");n&&(n.textContent="\u25B6")}}W(!0)}function W(e){let t=document.getElementById("chatForm"),o=t?.querySelector('input[name="message"]'),n=t?.querySelector('button[type="submit"]');!t||!o||!n||(w&&(clearTimeout(w),w=null),o.disabled=!e,e?(n.disabled=!1,n.textContent="Send",n.classList.remove("stop-btn"),n.onclick=null,o.focus()):(n.disabled=!0,n.textContent="Send",n.classList.remove("stop-btn"),w=setTimeout(()=>{f&&(n.disabled=!1,n.textContent="Stop",n.classList.add("stop-btn"),n.onclick=s=>{s.preventDefault(),$()})},400)))}function z(){let e=document.getElementById("chatForm");e&&e.addEventListener("submit",t=>{t.preventDefault();let o=e.querySelector('input[name="message"]'),n=o.value.trim(),s=document.getElementById("selectedModel").value,a=document.getElementById("imageData").value;if(!n)return;W(!1),Q(n,!!a),o.value="",v(),V(n,s,a)})}window.removeImage=v;window.scrollToBottom=m;window.toggleSessionPanel=C;window.toggleNewChatForm=F;window.createNewSession=q;window.switchSession=I;window.deleteSession=b;window.toggleModelDropdown=L;window.selectModel=M;window.loadModels=S;window.toggleActivityBox=J;window.stopStreaming=$;document.body.addEventListener("htmx:afterSwap",()=>{m()});document.addEventListener("DOMContentLoaded",()=>{D(),z(),P(),R(),j()});
//# sourceMappingURL=bundle.js.map
