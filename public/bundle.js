var pe=Object.defineProperty;var U=(e,t)=>()=>(e&&(t=e(e=0)),t);var ge=(e,t)=>{for(var o in t)pe(e,o,{get:t[o],enumerable:!0})};function z(){return l.activeSessionId}function E(){return l.currentCwd}function J(){return l.selectedModel}function k(){return l.activeEventSource}function B(e,t){l.activeSessionId=e,l.currentCwd=t}function C(e){l.selectedModel=e;let t=document.getElementById("selectedModel");t&&(t.value=e)}function h(e,t=null){l.isStreaming=e,l.activeEventSource=t}function D(e){l.hasImage=e}function W(e){e.lastModel&&C(e.lastModel),e.lastCwd&&(l.currentCwd=e.lastCwd),e.lastSessionId!==void 0&&(l.activeSessionId=e.lastSessionId)}var fe,l,v=U(()=>{"use strict";fe="claude-sonnet-4",l={activeSessionId:null,currentCwd:"",selectedModel:fe,isStreaming:!1,activeEventSource:null,hasImage:!1}});var X={};ge(X,{applyModelPreference:()=>O,getNewChatCwd:()=>P,hideNewChat:()=>x,loadModels:()=>L,selectModel:()=>M,setAvailableModels:()=>A,showNewChat:()=>p,showNewChatError:()=>N});function A(e){$=e,console.log("[MODEL] Available models from SDK:",e.map(t=>t.id))}function H(){return $.length>0?$:he}function p(e){let t=document.getElementById("newChat"),o=document.getElementById("chat"),n=document.getElementById("newChatCwd"),s=document.getElementById("newChatError");t&&o&&(t.classList.remove("hidden"),o.classList.add("hidden"),s&&(s.textContent=""),n&&e&&(n.value=e),L())}function x(){let e=document.getElementById("newChat"),t=document.getElementById("chat");e&&t&&(e.classList.add("hidden"),t.classList.remove("hidden"))}function P(){return document.getElementById("newChatCwd")?.value.trim()||""}function N(e){let t=document.getElementById("newChatError");t&&(t.textContent=e)}function L(){let e=document.getElementById("modelList");if(!e)return;e.innerHTML="";let t=J(),o=H();for(let n of o){let s=document.createElement("div");s.className="model-item",n.id===t&&s.classList.add("active"),s.dataset.modelId=n.id,s.onclick=()=>M(n.id);let i=document.createElement("span");i.className="model-name",i.textContent=n.name,s.appendChild(i);let r=document.createElement("span");r.className="model-cost",n.cost===0?(r.textContent="free",r.classList.add("free")):n.cost<1?(r.textContent=`${n.cost}x`,r.classList.add("cheap")):n.cost>1?(r.textContent=`${n.cost}x`,r.classList.add("expensive")):r.textContent="1x",s.appendChild(r),e.appendChild(s)}}function M(e){C(e);let o=H().find(s=>s.id===e);if(o){let s=document.querySelector('input[name="message"]');s&&(s.placeholder=`Ask ${o.name}...`)}document.querySelectorAll(".model-item").forEach(s=>{s.dataset.modelId===e?s.classList.add("active"):s.classList.remove("active")}),fetch("/api/preferences",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lastModel:e})}).catch(()=>{})}function O(e){let t=H();if(e.lastModel&&t.find(o=>o.id===e.lastModel)){C(e.lastModel);let o=t.find(n=>n.id===e.lastModel);if(o){let n=document.querySelector('input[name="message"]');n&&(n.placeholder=`Ask ${o.name}...`)}}}var he,$,w=U(()=>{"use strict";v();he=[{id:"claude-sonnet-4",name:"Claude Sonnet 4",cost:1},{id:"claude-sonnet-4.5",name:"Claude Sonnet 4.5",cost:1},{id:"claude-opus-4.5",name:"Claude Opus 4.5",cost:3},{id:"claude-haiku-4.5",name:"Claude Haiku 4.5",cost:.33},{id:"gpt-4.1",name:"GPT-4.1",cost:0},{id:"gpt-4o",name:"GPT-4o",cost:0}],$=[]});v();function G(){document.addEventListener("paste",e=>{let t=e.clipboardData?.items;if(t)for(let o=0;o<t.length;o++){let n=t[o];if(n.type.indexOf("image")!==-1){e.preventDefault();let s=n.getAsFile();if(!s)continue;let i=new FileReader;i.onload=r=>{let a=r.target?.result,c=document.getElementById("imageData"),d=document.getElementById("previewImg"),g=document.getElementById("imagePreview");c&&(c.value=a),d&&(d.src=a),g&&g.classList.add("visible"),D(!0)},i.onerror=r=>console.error("FileReader error:",r),i.readAsDataURL(s);break}}})}function I(){let e=document.getElementById("imageData"),t=document.getElementById("previewImg"),o=document.getElementById("imagePreview");e&&(e.value=""),t&&(t.src=""),o&&o.classList.remove("visible"),D(!1)}function u(){let e=document.getElementById("chatView");e&&(console.log("[SCROLL] chatView before:",e.scrollTop,"scrollHeight:",e.scrollHeight,"clientHeight:",e.clientHeight),e.scrollTop=e.scrollHeight,console.log("[SCROLL] chatView after:",e.scrollTop))}function K(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>t[o])}function Q(e){if(!e)return"";let t=Date.now(),o=new Date(e).getTime(),n=t-o,s=Math.floor(n/6e4),i=Math.floor(n/36e5),r=Math.floor(n/864e5),a=Math.floor(r/7),c=Math.floor(r/30),d=Math.floor(r/365);return d>=1?`${d} year${d>1?"s":""}`:c>=1?`${c} month${c>1?"s":""}`:a>=1?`${a} week${a>1?"s":""}`:r>=1?`${r} day${r>1?"s":""}`:i>=1?`${i} hour${i>1?"s":""}`:s>=1?`${s} min`:"just now"}w();v();async function S(){try{let e=await fetch("/api/history");if(e.ok){let t=await e.text(),o=document.getElementById("chat");o&&t.trim()?(o.innerHTML=t,x(),typeof window.renderMarkdown=="function"&&window.renderMarkdown()):p()}else p()}catch(e){console.error("Failed to load history:",e),p()}}async function Y(){try{let e=await fetch("/api/preferences");if(e.ok){let t=await e.json();return W(t),O(t),t.lastSessionId!=null}}catch(e){console.error("Failed to load preferences:",e)}return!1}v();w();function Z(){let e=document.getElementById("chatView"),t=document.getElementById("sessionView"),o=document.getElementById("chatFooter"),n=document.getElementById("menuBtn");!e||!t||(e.classList.remove("active"),t.classList.add("active"),o?.classList.add("hidden"),n?.classList.add("active"),j())}function F(){let e=document.getElementById("chatView"),t=document.getElementById("sessionView"),o=document.getElementById("chatFooter"),n=document.getElementById("menuBtn");if(!e||!t)return;if(t.classList.contains("active")){t.classList.remove("active"),e.classList.add("active"),o?.classList.remove("hidden"),n?.classList.remove("active");let i=document.getElementById("chat");i&&i.children.length===0&&p(E())}else e.classList.remove("active"),t.classList.add("active"),o?.classList.add("hidden"),n?.classList.add("active"),j()}async function j(){try{let e=await fetch("/api/sessions");if(!e.ok)return;let t=await e.json(),{activeSessionId:o,currentCwd:n,grouped:s,models:i}=t;B(o,n),i&&i.length>0&&A(i);let r=document.getElementById("sessionList");if(!r)return;r.innerHTML="";let a=Object.keys(s).sort((c,d)=>c===n?-1:d===n?1:c.localeCompare(d));for(let c of a){let d=s[c];if(c==="(unknown)"||!c){let y=document.createElement("div");y.className="cwd-header omitted",y.textContent=`no cwd (${d.length} omitted)`,r.appendChild(y);continue}let g=document.createElement("div");g.className="cwd-header",g.textContent=c===n?`${c} (current)`:c,r.appendChild(g);for(let y of d){let ue=ve(y,o);r.appendChild(ue)}}}catch(e){console.error("Failed to load sessions:",e)}}function ve(e,t){let o=document.createElement("div");o.className="session-item",e.sessionId===t&&o.classList.add("active"),o.dataset.sessionId=e.sessionId;let n=document.createElement("span");n.className="session-summary";let s=e.summary||"No summary",i=e.updatedAt?` (${Q(e.updatedAt)})`:"";n.textContent=s+i,n.onclick=()=>q(e.sessionId),o.appendChild(n);let r=document.createElement("button");return r.className="session-delete",r.textContent="\xD7",r.onclick=a=>{a.stopPropagation(),R(e.sessionId,e.summary)},o.appendChild(r),o}async function q(e){if(e===z()){F(),u();return}let t=document.querySelector(`.session-item[data-session-id="${e}"]`);t&&t.classList.add("loading");try{let o=await fetch(`/api/sessions/${e}/resume`,{method:"POST"});if(o.ok){let n=await o.json();B(n.sessionId,n.cwd||E()),await S();let s=document.getElementById("chatView"),i=document.getElementById("sessionView"),r=document.getElementById("chatFooter"),a=document.getElementById("menuBtn");i?.classList.remove("active"),s?.classList.add("active"),r?.classList.remove("hidden"),a?.classList.remove("active"),requestAnimationFrame(()=>u())}else{let n=await o.json();t&&t.classList.remove("loading"),alert("Failed to switch session: "+n.error)}}catch(o){console.error("Failed to switch session:",o),t&&t.classList.remove("loading")}}async function R(e,t){let o=t||e.slice(0,8);if(confirm(`Delete session "${o}"?

This cannot be undone.`))try{let n=await fetch(`/api/sessions/${e}`,{method:"DELETE"});if(n.ok){if((await n.json()).wasActive){let i=document.getElementById("chat");i&&(i.innerHTML=""),p(E())}j()}else{let s=await n.json();alert("Failed to delete session: "+s.error)}}catch(n){console.error("Failed to delete session:",n),alert("Failed to delete session: "+n.message)}}function ee(){let e=document.getElementById("chatView"),t=document.getElementById("sessionView"),o=document.getElementById("chatFooter"),n=document.getElementById("chat"),s=document.getElementById("menuBtn");e&&t&&(t.classList.remove("active"),e.classList.add("active"),o?.classList.remove("hidden"),s?.classList.remove("active"),n&&(n.innerHTML=""),p(E()),document.querySelector('form input[name="message"]')?.focus())}w();function m(e,t,o=null){let n=document.querySelector("#pending-response .activity-box");if(!n)return;let s=document.createElement("div");if(s.className=`activity-item ${e}`,o){let r=document.createElement("div");r.className="activity-summary",r.textContent=t,r.onclick=()=>s.classList.toggle("expanded"),s.appendChild(r);let a=document.createElement("div");a.className="activity-details",a.textContent=o,s.appendChild(a)}else s.textContent=t;n.appendChild(s);let i=n.closest(".activity-wrapper");if(i){let r=n.querySelectorAll(".activity-item").length,a=i.querySelector(".activity-count");a&&(a.textContent=`(${r})`)}n.scrollTop=n.scrollHeight}function te(e){let t=e.closest(".activity-wrapper");if(!t)return;let o=t.classList.contains("collapsed");t.classList.toggle("collapsed");let n=e.querySelector(".activity-icon");n&&(n.textContent=o?"\u25BC":"\u25B6")}function ne(e){if(!e)return"";let t=[];for(let[o,n]of Object.entries(e))if(typeof n=="string"){let s=n.length>80?n.substring(0,80)+"...":n;t.push(`${o}: ${s}`)}else typeof n=="object"?t.push(`${o}: ${JSON.stringify(n).substring(0,60)}...`):t.push(`${o}: ${n}`);return t.join(", ")}function oe(e){if(!e)return"";if(e.content){let t=typeof e.content=="string"?e.content:JSON.stringify(e.content);return t.length>500?t.substring(0,500)+"...":t}return JSON.stringify(e).substring(0,200)}function se(e){let{command:t,exitCode:o,output:n}=e,s=o===0||o===void 0?"":` (exit ${o})`;return"```bash\n$ "+t+s+`
`+n+"\n```"}function ie(e){let{data:t,path:o,highlight:n,startLine:s,endLine:i,totalLines:r}=e,a=n||"",c=o?`**${o}**`:"",d=s&&i?` (lines ${s}-${i} of ${r})`:"";return c+d+"\n\n```"+a+`
`+t+"\n```"}async function re(e){if(!e?.id)return;let t=document.querySelector("#pending-response .outputs-container");if(t)try{let o=await fetch(`/api/outputs/${e.id}?format=json`);if(!o.ok)return;let{data:n,metadata:s}=await o.json();s.type==="embed"||s.html?we(t,n,s):s.mimeType?.startsWith("image/")?ye(t,e.id,n,s):s.command!==void 0?Ee(t,n,s):s.path?xe(t,n,s):ae(t,n)}catch(o){console.error("Error displaying output:",o)}}function we(e,t,o){let n=document.createElement("div");n.className="output-embed";let s=o.html||t;window.DOMPurify?n.innerHTML=window.DOMPurify.sanitize(s,{ADD_TAGS:["iframe"],ADD_ATTR:["allow","allowfullscreen","frameborder","scrolling","src","width","height"]}):n.innerHTML=s,e.appendChild(n)}function ye(e,t,o,n){let s=document.createElement("img");s.className="output-image",s.src=n.mimeType&&typeof o=="string"?`data:${n.mimeType};base64,${o}`:`/api/outputs/${t}`,s.alt=n.path||"Image",e.appendChild(s)}function Ee(e,t,o){let n=se({command:o.command||"",exitCode:o.exitCode,output:t});ce(e,n,"output-terminal")}function xe(e,t,o){let n=ie({data:t,path:o.path,highlight:o.highlight,startLine:o.startLine,endLine:o.endLine,totalLines:o.totalLines});ce(e,n,"output-code")}function ae(e,t){let o=document.createElement("pre");o.className="output-raw",o.textContent=t,e.appendChild(o)}function ce(e,t,o){if(!window.marked||!window.DOMPurify){ae(e,t);return}let n=document.createElement("div");n.className=`output-content ${o}`,n.innerHTML=window.DOMPurify.sanitize(window.marked.parse(t)),e.appendChild(n),n.querySelectorAll("pre code").forEach(s=>{window.hljs&&window.hljs.highlightElement(s)})}v();w();var b=null;function Ce(e,t){let o=document.getElementById("chat");if(!o)throw new Error("Chat element not found");x();let n=document.createElement("div");n.className="message user",n.innerHTML=`${K(e)}${t?' <span class="image-indicator">[img]</span>':""}`,o.appendChild(n);let s=document.createElement("div");return s.className="message assistant pending",s.id="pending-response",s.setAttribute("data-markdown",""),s.innerHTML=`
    <div class="activity-wrapper">
      <div class="activity-header" onclick="toggleActivityBox(this)">
        <span class="activity-icon">\u25B6</span>
        <span class="activity-label">Activity</span>
        <span class="activity-count"></span>
      </div>
      <div class="activity-box"></div>
    </div>
    <div class="outputs-container"></div>
    <div class="markdown-content streaming-cursor"></div>
  `,o.appendChild(s),u(),s}async function Ie(e,t,o,n){h(!0,null);try{let s=await fetch("/api/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e,model:t,imageData:o,cwd:n})});if(!s.ok){let a=await s.json().catch(()=>({error:"Request failed"}));throw new Error(a.error||`HTTP ${s.status}`)}let{streamId:i}=await s.json(),r=new EventSource(`/api/stream/${i}`);h(!0,r),Le(r)}catch(s){console.error("Send message error:",s),h(!1,null),m("error",`Error: ${s instanceof Error?s.message:"Unknown error"}`),T()}}function f(e,t,o,n){try{let s=t?JSON.parse(t):{};switch(e){case"assistant.message_delta":if(s.deltaContent){if(n.setContent(n.getContent()+s.deltaContent),o&&(o.textContent=n.getContent()),!n.getFirstDelta()){let i=document.querySelector("#pending-response .activity-wrapper");if(i){i.classList.add("collapsed");let r=i.querySelector(".activity-icon");r&&(r.textContent="\u25B6")}n.setFirstDelta(!0)}u()}break;case"assistant.message":if(s.content&&o){o.textContent=s.content,o.classList.remove("streaming-cursor");let i=document.getElementById("pending-response");i&&(i.dataset.markdownProcessed="false"),typeof window.renderMarkdown=="function"&&window.renderMarkdown()}break;case"assistant.turn_start":m("turn",`Turn ${parseInt(s.turnId||0)+1}...`);break;case"assistant.intent":s.intent&&m("intent",`Intent: ${s.intent}`);break;case"tool.execution_start":{let i=s.toolName||s.name||"tool",r=ne(s.arguments);m("tool",`\u25B6 ${i}`,r?`Arguments: ${r}`:null);break}case"tool.execution_complete":{let i=s.toolName||s.name||"tool",r=s.success?"\u2713":"\u2717";m("tool-result",`${r} ${i}`,s.result?oe(s.result):null),s._output&&re(s._output);break}case"session.error":m("error",`Error: ${s.message||"Unknown error"}`);break;case"error":m("error",`Error: ${s.message||"Connection error"}`);break}}catch{}}function Le(e){let t=document.querySelector("#pending-response .markdown-content"),o="",n=!1,s={getContent:()=>o,setContent:i=>{o=i},getFirstDelta:()=>n,setFirstDelta:i=>{n=i}};e.addEventListener("assistant.message_delta",i=>{f("assistant.message_delta",i.data,t,s)}),e.addEventListener("assistant.message",i=>{f("assistant.message",i.data,t,s)}),e.addEventListener("assistant.turn_start",i=>{f("assistant.turn_start",i.data,t,s)}),e.addEventListener("assistant.intent",i=>{f("assistant.intent",i.data,t,s)}),e.addEventListener("tool.execution_start",i=>{f("tool.execution_start",i.data,t,s)}),e.addEventListener("tool.execution_complete",i=>{f("tool.execution_complete",i.data,t,s)}),e.addEventListener("session.error",i=>{f("session.error",i.data,t,s)}),e.addEventListener("error",i=>{f("error",i.data||"{}",t,s)}),e.addEventListener("done",()=>{e.close(),h(!1,null),T()}),e.addEventListener("session.idle",()=>{}),e.onerror=i=>{console.error("EventSource error:",i),e.close(),h(!1,null),!o&&!n&&m("error","Connection lost"),T()}}function V(){let e=k();if(e){e.close(),h(!1,null),m("info","Stopped by user");let t=document.querySelector("#pending-response .markdown-content");t&&t.classList.remove("streaming-cursor"),T()}}function T(){let e=document.getElementById("pending-response");if(e){e.classList.remove("pending"),e.removeAttribute("id");let t=e.querySelector(".markdown-content");t&&t.classList.remove("streaming-cursor");let o=e.querySelector(".activity-wrapper");if(o){o.classList.add("collapsed");let n=o.querySelector(".activity-icon");n&&(n.textContent="\u25B6")}}de(!0)}function de(e){let t=document.getElementById("chatForm"),o=t?.querySelector('input[name="message"]'),n=t?.querySelector('button[type="submit"]');!t||!o||!n||(b&&(clearTimeout(b),b=null),o.disabled=!e,e?(n.disabled=!1,n.textContent="Send",n.classList.remove("stop-btn"),n.onclick=null,o.focus()):(n.disabled=!0,n.textContent="Send",n.classList.remove("stop-btn"),b=setTimeout(()=>{k()&&(n.disabled=!1,n.textContent="Stop",n.classList.add("stop-btn"),n.onclick=s=>{s.preventDefault(),V()})},400)))}function le(){let e=document.getElementById("chatForm");e&&e.addEventListener("submit",t=>{t.preventDefault();let o=e.querySelector('input[name="message"]'),n=o.value.trim(),i=document.getElementById("selectedModel")?.value,r=document.getElementById("imageData").value,a=P(),c=document.getElementById("newChat");if(c&&!c.classList.contains("hidden")&&!a){N("Please enter a working directory");return}if(console.log("[MODEL] Client sending request with model:",i||"(undefined)"),a&&console.log("[CWD] New session cwd:",a),!n)return;de(!1),Ce(n,!!r),o.value="",I(),Ie(n,i,r,a)})}var Me=["hx-get","hx-post","hx-put","hx-delete","hx-patch","hx-trigger","hx-target","hx-swap","hx-vals","hx-sync","hx-confirm","hx-boost","hx-push-url","hx-on","hx-ext","hx-include","hx-indicator","hx-params","hx-request","hx-select","hx-select-oob","hx-swap-oob","hx-preserve","hx-prompt","hx-replace-url","hx-disable","hx-disabled-elt","hx-disinherit","hx-encoding","hx-headers","hx-history","hx-history-elt","hx-inherit","hx-validate","onclick","ondblclick","onmousedown","onmouseup","onmouseover","onmousemove","onmouseout","onmouseenter","onmouseleave","onkeydown","onkeyup","onkeypress","onfocus","onblur","onchange","oninput","onsubmit","onreset","onload","onerror","onabort","onbeforeunload","onunload","onresize","onscroll","onwheel","oncopy","oncut","onpaste","ondrag","ondragstart","ondragend","ondragenter","ondragleave","ondragover","ondrop","oncontextmenu","onshow","ontoggle","onanimationstart","onanimationend","onanimationiteration","ontransitionend","onpointerdown","onpointerup","onpointermove"],Se=["script","iframe","object","embed","form","input","button","textarea","select","option"];function be(){mermaid.initialize({startOnLoad:!1,theme:"dark",themeVariables:{primaryColor:"#0969da",primaryTextColor:"#d4d4d4",primaryBorderColor:"#30363d",lineColor:"#6e7681",secondaryColor:"#1f6feb",tertiaryColor:"#2d333b"}})}function Te(){marked.use({renderer:{code(e,t){return t==="mermaid"?`<div class="mermaid-diagram" id="${"mermaid-"+Math.random().toString(36).substr(2,9)}">${e}</div>`:`<pre><code class="hljs ${t?`language-${t}`:""}">${e}</code></pre>`}}})}async function _(){let e=document.querySelectorAll("[data-markdown]");for(let t of e){let o=t;if(o.dataset.markdownProcessed==="true")continue;let n=o.querySelector(".markdown-content");if(!n)continue;let s=n.textContent??"",i=marked.parse(s),r=DOMPurify.sanitize(i,{FORBID_ATTR:Me,FORBID_TAGS:Se});n.innerHTML=r;let a=n.querySelectorAll(".mermaid-diagram");for(let c of a)try{let{svg:d}=await mermaid.render(c.id+"-svg",c.textContent??"");c.innerHTML=d}catch(d){console.error("Mermaid rendering error:",d);let g=d instanceof Error?d.message:"Unknown error";c.innerHTML=`<pre class="mermaid-error">Error rendering diagram: ${g}</pre>`}o.dataset.markdownProcessed="true"}typeof hljs<"u"&&hljs.highlightAll()}function me(){be(),Te(),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",_):_(),document.body.addEventListener("htmx:afterSwap",_)}window.removeImage=I;window.scrollToBottom=u;window.toggleSessionPanel=F;window.showNewChat=ee;window.switchSession=q;window.deleteSession=R;window.selectModel=M;window.loadModels=L;window.toggleActivityBox=te;window.stopStreaming=V;document.body.addEventListener("htmx:afterSwap",()=>{u()});document.addEventListener("DOMContentLoaded",async()=>{G(),le(),me();try{let t=await fetch("/api/sessions");if(t.ok){let o=await t.json();if(o.models&&o.models.length>0){let{setAvailableModels:n}=await Promise.resolve().then(()=>(w(),X));n(o.models)}}}catch(t){console.error("Failed to fetch models on startup:",t)}await Y()?S():Z()});
//# sourceMappingURL=bundle.js.map
