<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caco</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="highlight-dark.min.css">
  <script src="marked.min.js"></script>
  <script src="mermaid.min.js"></script>
  <script src="highlight.min.js"></script>
  <script src="purify.min.js"></script>
</head>
<body>
  <!--
    ==========================================================================
    VIEW STATE: All view visibility changes MUST go through view-controller.ts
    Do NOT manually toggle .active/.hidden classes on views.
    Use: setViewState('sessions' | 'newChat' | 'chatting' | 'applet')
    ==========================================================================
  -->

  <!-- Floating menu button (top-left, always visible) -->
  <button type="button" id="menuBtn" class="menu-btn" onclick="toggleSessions()" aria-label="Toggle sessions">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Applet toggle button (top-right, visible in chatting/applet states) -->
  <button type="button" id="appletBtn" class="applet-btn hidden" onclick="toggleApplet()" aria-label="Toggle applet">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <main>
    <!-- Session manager view (full-screen overlay) -->
    <div id="sessionView" class="session-overlay">
      <div id="usageInfo" class="usage-info"></div>
      <button type="button" class="new-chat-btn" onclick="showNewChat()">+ New Chat</button>
      <div id="sessionList"></div>
    </div>

    <!-- Work area: chat and applet side-by-side on desktop -->
    <div class="work-area">
      <!-- Chat panel (left on desktop, main on mobile) -->
      <div id="chatPanel" class="chat-panel">
        <div id="chatScroll" class="chat-scroll">
          <div id="chatView" class="chat-view">
            <!-- New chat form (shown when no messages) -->
            <div id="newChat" class="new-chat">
              <h2>New Chat</h2>
              <div class="new-chat-cwd">
                <label for="newChatCwd">Working directory</label>
                <input type="text" id="newChatCwd" placeholder="/path/to/project">
              </div>
              <h3>Select a model</h3>
              <div id="modelList"></div>
              <div id="newChatError" class="new-chat-error"></div>
            </div>
            <!-- Chat messages (shown when has messages) -->
            <div id="chat" class="hidden">
              <!-- Messages will appear here -->
            </div>
            <!-- Working cursor (shown during streaming) -->
            <div id="workingCursor" class="streaming-cursor hidden"></div>
          </div>
        </div>
      </div>

      <!-- Applet panel (right on desktop, toggled on mobile) -->
      <div id="appletPanel" class="applet-panel hidden">
        <div id="appletView">
          <!-- .applet-instance divs are created dynamically by applet-runtime -->
        </div>
      </div>
    </div>
  </main>

  <!-- Toast notifications (floats above input) -->
  <div id="toast" class="toast hidden" role="alert">
    <span class="toast-message"></span>
    <button type="button" class="toast-close" onclick="hideToast()" aria-label="Close">×</button>
  </div>

  <!-- Footer with chat input -->
  <footer id="chatFooter">
    <div id="imagePreview" class="image-preview">
      <img id="previewImg" src="" alt="Pasted image">
      <span>Image attached</span>
      <button type="button" class="remove-btn" onclick="removeImage()">× Remove</button>
    </div>
    <form id="chatForm">
      <input type="hidden" id="imageData" name="imageData">
      <input type="hidden" id="selectedModel" name="model" value="claude-sonnet-4">
      <div class="input-bar">
        <textarea 
          class="input-text"
          name="message" 
          placeholder="Ask anything..." 
          required
          autofocus
          rows="1"
        ></textarea>
        <button type="submit" class="send-btn">Send</button>
        <button type="button" class="stop-btn" onclick="stopStreaming()">Stop</button>
      </div>
    </form>
  </footer>

  <script type="module" src="bundle.js"></script>
</body>
</html>
