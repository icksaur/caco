var m={activeSessionId:null,currentCwd:"",selectedModel:"claude-sonnet-4",isStreaming:!1,activeEventSource:null,hasImage:!1};function P(){return m.activeSessionId}function N(){return m.currentCwd}function k(){return m.selectedModel}function L(){return m.activeEventSource}function H(e,t){m.activeSessionId=e,m.currentCwd=t}function v(e){m.selectedModel=e;let t=document.getElementById("selectedModel");t&&(t.value=e)}function g(e,t=null){m.isStreaming=e,m.activeEventSource=t}function M(e){m.hasImage=e}function A(e){e.lastModel&&v(e.lastModel),e.lastCwd&&(m.currentCwd=e.lastCwd),e.lastSessionId!==void 0&&(m.activeSessionId=e.lastSessionId)}function O(){document.addEventListener("paste",e=>{let t=e.clipboardData?.items;if(t)for(let o=0;o<t.length;o++){let n=t[o];if(n.type.indexOf("image")!==-1){e.preventDefault();let s=n.getAsFile();if(!s)continue;let i=new FileReader;i.onload=r=>{let c=r.target?.result,l=document.getElementById("imageData"),a=document.getElementById("previewImg"),d=document.getElementById("imagePreview");l&&(l.value=c),a&&(a.src=c),d&&d.classList.add("visible"),M(!0)},i.onerror=r=>console.error("FileReader error:",r),i.readAsDataURL(s);break}}})}function y(){let e=document.getElementById("imageData"),t=document.getElementById("previewImg"),o=document.getElementById("imagePreview");e&&(e.value=""),t&&(t.src=""),o&&o.classList.remove("visible"),M(!1)}function u(){let e=document.querySelector("main");e&&(e.scrollTop=e.scrollHeight)}function F(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>t[o])}function j(e){if(!e)return"";let t=Date.now(),o=new Date(e).getTime(),n=t-o,s=Math.floor(n/6e4),i=Math.floor(n/36e5),r=Math.floor(n/864e5),c=Math.floor(r/7),l=Math.floor(r/30),a=Math.floor(r/365);return a>=1?`${a} year${a>1?"s":""}`:l>=1?`${l} month${l>1?"s":""}`:c>=1?`${c} week${c>1?"s":""}`:r>=1?`${r} day${r>1?"s":""}`:i>=1?`${i} hour${i>1?"s":""}`:s>=1?`${s} min`:"just now"}var w=[{id:"claude-sonnet-4",name:"Claude Sonnet 4",cost:1},{id:"claude-sonnet-4.5",name:"Claude Sonnet 4.5",cost:1},{id:"claude-opus-4.5",name:"Claude Opus 4.5",cost:3},{id:"claude-haiku-4.5",name:"Claude Haiku 4.5",cost:.33},{id:"gpt-4.1",name:"GPT-4.1",cost:0},{id:"gpt-4o",name:"GPT-4o",cost:0},{id:"gpt-5-mini",name:"GPT-5 mini",cost:0},{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",cost:1},{id:"gemini-3-flash-preview",name:"Gemini 3 Flash",cost:.33}];function I(){let e=document.getElementById("modelDropdown"),t=document.querySelector(".hamburger-btn.model-btn");if(!e)return;e.classList.contains("visible")?(e.classList.remove("visible"),t?.classList.remove("active")):(e.classList.add("visible"),t?.classList.add("active"),x())}function q(){document.addEventListener("click",e=>{let t=document.getElementById("modelDropdown"),o=document.querySelector(".hamburger-btn.model-btn");t&&o&&!t.contains(e.target)&&!o.contains(e.target)&&(t.classList.remove("visible"),o.classList.remove("active"))})}function x(){let e=document.getElementById("modelList");if(!e)return;e.innerHTML="";let t=k();for(let o of w){let n=document.createElement("div");n.className="model-item",o.id===t&&n.classList.add("active"),n.dataset.modelId=o.id,n.onclick=()=>C(o.id);let s=document.createElement("span");s.className="model-name",s.textContent=o.name,n.appendChild(s);let i=document.createElement("span");i.className="model-cost",o.cost===0?(i.textContent="free",i.classList.add("free")):o.cost<1?(i.textContent=`${o.cost}x`,i.classList.add("cheap")):o.cost>1?(i.textContent=`${o.cost}x`,i.classList.add("expensive")):i.textContent="1x",n.appendChild(i),e.appendChild(n)}}function C(e){v(e);let t=w.find(n=>n.id===e),o=document.querySelector('input[name="message"]');o&&t&&(o.placeholder=`Ask ${t.name}...`),fetch("/api/preferences",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lastModel:e})}).catch(()=>{}),I()}function R(e){if(e.lastModel&&w.find(t=>t.id===e.lastModel)){v(e.lastModel);let t=w.find(n=>n.id===e.lastModel),o=document.querySelector('input[name="message"]');o&&t&&(o.placeholder=`Ask ${t.name}...`)}}async function J(){try{let e=await fetch("/api/history");if(e.ok){let t=await e.text(),o=document.getElementById("chat");o&&t.trim()&&(o.innerHTML=t,typeof window.renderMarkdown=="function"&&window.renderMarkdown()),u()}}catch(e){console.error("Failed to load history:",e)}}async function _(){try{let e=await fetch("/api/preferences");if(e.ok){let t=await e.json();A(t),R(t)}}catch(e){console.error("Failed to load preferences:",e)}}function b(){let e=document.getElementById("chat"),t=document.getElementById("sessionPanel"),o=document.getElementById("modelPanel"),n=document.querySelector(".hamburger-btn:not(.model-btn)"),s=document.querySelector(".hamburger-btn.model-btn");if(!t||!e)return;t.classList.contains("visible")?(t.classList.remove("visible"),e.classList.remove("hidden"),n?.classList.remove("active")):(o?.classList.remove("visible"),s?.classList.remove("active"),t.classList.add("visible"),e.classList.add("hidden"),n?.classList.add("active"),G())}async function G(){try{let e=await fetch("/api/sessions");if(!e.ok)return;let t=await e.json(),{activeSessionId:o,currentCwd:n,grouped:s}=t;H(o,n);let i=document.getElementById("sessionList");if(!i)return;i.innerHTML="";let r=Object.keys(s).sort((c,l)=>c===n?-1:l===n?1:c.localeCompare(l));for(let c of r){let l=s[c];if(c==="(unknown)"||!c){let d=document.createElement("div");d.className="cwd-header omitted",d.textContent=`no cwd (${l.length} omitted)`,i.appendChild(d);continue}let a=document.createElement("div");a.className="cwd-header",a.textContent=c===n?`${c} (current)`:c,i.appendChild(a);for(let d of l){let f=Z(d,o);i.appendChild(f)}}}catch(e){console.error("Failed to load sessions:",e)}}function Z(e,t){let o=document.createElement("div");o.className="session-item",e.sessionId===t&&o.classList.add("active"),o.dataset.sessionId=e.sessionId;let n=document.createElement("span");n.className="session-summary";let s=e.summary||"No summary",i=e.updatedAt?` (${j(e.updatedAt)})`:"";n.textContent=s+i,n.onclick=()=>T(e.sessionId),o.appendChild(n);let r=document.createElement("button");return r.className="session-delete",r.textContent="\xD7",r.onclick=c=>{c.stopPropagation(),$(e.sessionId,e.summary)},o.appendChild(r),o}async function T(e){if(e===P()){b(),u();return}let t=document.querySelector(`.session-item[data-session-id="${e}"]`);t&&t.classList.add("loading");try{let o=await fetch(`/api/sessions/${e}/resume`,{method:"POST"});if(o.ok)window.location.reload();else{let n=await o.json();t&&t.classList.remove("loading"),alert("Failed to switch session: "+n.error)}}catch(o){console.error("Failed to switch session:",o),t&&t.classList.remove("loading")}}async function $(e,t){let o=t||e.slice(0,8);if(confirm(`Delete session "${o}"?

This cannot be undone.`))try{let n=await fetch(`/api/sessions/${e}`,{method:"DELETE"});if(n.ok){if((await n.json()).wasActive){let i=document.getElementById("chat");i&&(i.innerHTML="")}G()}else{let s=await n.json();alert("Failed to delete session: "+s.error)}}catch(n){console.error("Failed to delete session:",n),alert("Failed to delete session: "+n.message)}}function U(){let e=document.getElementById("newChatForm"),t=document.getElementById("newChatPath"),o=document.getElementById("newChatError");!e||!t||(e.classList.contains("expanded")?(e.classList.remove("expanded"),o&&(o.classList.remove("visible"),o.textContent="")):(e.classList.add("expanded"),t.value=N(),t.focus(),t.select()))}async function W(){let e=document.getElementById("newChatPath"),t=document.getElementById("newChatError"),o=e?.value.trim();if(!o){t&&(t.textContent="Please enter a working directory path",t.classList.add("visible"));return}try{let n=await fetch("/api/sessions/new",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cwd:o})});if(n.ok)window.location.reload();else{let s=await n.json();t&&(t.textContent=s.error||"Failed to create session",t.classList.add("visible"))}}catch(n){console.error("Failed to create session:",n),t&&(t.textContent="Failed to create session: "+n.message,t.classList.add("visible"))}}function p(e,t,o=null){let n=document.querySelector("#pending-response .activity-box");if(!n)return;let s=document.createElement("div");if(s.className=`activity-item ${e}`,o){let r=document.createElement("div");r.className="activity-summary",r.textContent=t,r.onclick=()=>s.classList.toggle("expanded"),s.appendChild(r);let c=document.createElement("div");c.className="activity-details",c.textContent=o,s.appendChild(c)}else s.textContent=t;n.appendChild(s);let i=n.closest(".activity-wrapper");if(i){let r=n.querySelectorAll(".activity-item").length,c=i.querySelector(".activity-count");c&&(c.textContent=`(${r})`)}n.scrollTop=n.scrollHeight}function z(e){let t=e.closest(".activity-wrapper");if(!t)return;let o=t.classList.contains("collapsed");t.classList.toggle("collapsed");let n=e.querySelector(".activity-icon");n&&(n.textContent=o?"\u25BC":"\u25B6")}function K(e){if(!e)return"";let t=[];for(let[o,n]of Object.entries(e))if(typeof n=="string"){let s=n.length>80?n.substring(0,80)+"...":n;t.push(`${o}: ${s}`)}else typeof n=="object"?t.push(`${o}: ${JSON.stringify(n).substring(0,60)}...`):t.push(`${o}: ${n}`);return t.join(", ")}function Q(e){if(!e)return"";if(e.content){let t=typeof e.content=="string"?e.content:JSON.stringify(e.content);return t.length>500?t.substring(0,500)+"...":t}return JSON.stringify(e).substring(0,200)}async function V(e){if(!e||!e.id)return;let t=document.querySelector("#pending-response .outputs-container");if(t)try{let o=await fetch(`/api/outputs/${e.id}?format=json`);if(!o.ok)return;let{data:n,metadata:s}=await o.json(),i="";if(e.type==="file"){let r=s.highlight||"",c=s.path?`**${s.path}**`:"",l=s.startLine&&s.endLine?` (lines ${s.startLine}-${s.endLine} of ${s.totalLines})`:"";i=`${c}${l}

\`\`\`${r}
${n}
\`\`\``}else if(e.type==="terminal"){let r=s.exitCode===0?"":` (exit ${s.exitCode})`;i=`\`\`\`bash
$ ${s.command}${r}
${n}
\`\`\``}else if(e.type==="image"){let r=document.createElement("img");r.className="output-image",r.src=s.mimeType&&typeof n=="string"?`data:${s.mimeType};base64,${n}`:`/api/outputs/${e.id}`,r.alt=s.path||"Image",t.appendChild(r);return}if(i&&window.marked&&window.DOMPurify){let r=document.createElement("div");r.className="output-content",r.innerHTML=window.DOMPurify.sanitize(window.marked.parse(i)),t.appendChild(r),r.querySelectorAll("pre code").forEach(c=>{window.hljs&&window.hljs.highlightElement(c)})}}catch(o){console.error("Error displaying output:",o)}}var h=null;function ee(e,t){let o=document.getElementById("chat");if(!o)throw new Error("Chat element not found");let n=document.createElement("div");n.className="message user",n.innerHTML=`${F(e)}${t?' <span class="image-indicator">[img]</span>':""}`,o.appendChild(n);let s=document.createElement("div");return s.className="message assistant pending",s.id="pending-response",s.setAttribute("data-markdown",""),s.innerHTML=`
    <div class="activity-wrapper">
      <div class="activity-header" onclick="toggleActivityBox(this)">
        <span class="activity-icon">\u25B6</span>
        <span class="activity-label">Activity</span>
        <span class="activity-count"></span>
      </div>
      <div class="activity-box"></div>
    </div>
    <div class="outputs-container"></div>
    <div class="markdown-content streaming-cursor"></div>
  `,o.appendChild(s),u(),s}function te(e,t,o){let n=new URLSearchParams({prompt:e,model:t});o&&n.set("imageData",o);let s=new EventSource(`/api/stream?${n.toString()}`);g(!0,s);let i=document.querySelector("#pending-response .markdown-content"),r="",c=!1;s.addEventListener("assistant.message_delta",l=>{let a=JSON.parse(l.data);if(a.deltaContent){if(r+=a.deltaContent,i&&(i.textContent=r),!c){let d=document.querySelector("#pending-response .activity-wrapper");if(d){d.classList.add("collapsed");let f=d.querySelector(".activity-icon");f&&(f.textContent="\u25B6")}c=!0}u()}}),s.addEventListener("assistant.message",l=>{let a=JSON.parse(l.data);if(a.content&&i){i.textContent=a.content,i.classList.remove("streaming-cursor");let d=document.getElementById("pending-response");d&&(d.dataset.markdownProcessed="false"),typeof window.renderMarkdown=="function"&&window.renderMarkdown()}}),s.addEventListener("assistant.turn_start",l=>{let a=JSON.parse(l.data);p("turn",`Turn ${parseInt(a.turnId||0)+1}...`)}),s.addEventListener("assistant.intent",l=>{let a=JSON.parse(l.data);a.intent&&p("intent",`Intent: ${a.intent}`)}),s.addEventListener("tool.execution_start",l=>{let a=JSON.parse(l.data),d=a.toolName||a.name||"tool",f=K(a.arguments),S=`\u25B6 ${d}`,E=f?`Arguments: ${f}`:null;p("tool",S,E)}),s.addEventListener("tool.execution_complete",l=>{let a=JSON.parse(l.data),d=a.toolName||a.name||"tool",S=`${a.success?"\u2713":"\u2717"} ${d}`,E=a.result?Q(a.result):null;p("tool-result",S,E),a._output&&V(a._output)}),s.addEventListener("session.error",l=>{let a=JSON.parse(l.data);p("error",`Error: ${a.message||"Unknown error"}`)}),s.addEventListener("error",l=>{let a=JSON.parse(l.data||"{}");p("error",`Error: ${a.message||"Connection error"}`)}),s.addEventListener("done",()=>{s.close(),g(!1,null),D()}),s.addEventListener("session.idle",()=>{}),s.onerror=l=>{console.error("EventSource error:",l),s.close(),g(!1,null),!r&&!c&&p("error","Connection lost"),D()}}function B(){let e=L();if(e){e.close(),g(!1,null),p("info","Stopped by user");let t=document.querySelector("#pending-response .markdown-content");t&&t.classList.remove("streaming-cursor"),D()}}function D(){let e=document.getElementById("pending-response");if(e){e.classList.remove("pending"),e.removeAttribute("id");let t=e.querySelector(".markdown-content");t&&t.classList.remove("streaming-cursor");let o=e.querySelector(".activity-wrapper");if(o){o.classList.add("collapsed");let n=o.querySelector(".activity-icon");n&&(n.textContent="\u25B6")}}X(!0)}function X(e){let t=document.getElementById("chatForm"),o=t?.querySelector('input[name="message"]'),n=t?.querySelector('button[type="submit"]');!t||!o||!n||(h&&(clearTimeout(h),h=null),o.disabled=!e,e?(n.disabled=!1,n.textContent="Send",n.classList.remove("stop-btn"),n.onclick=null,o.focus()):(n.disabled=!0,n.textContent="Send",n.classList.remove("stop-btn"),h=setTimeout(()=>{L()&&(n.disabled=!1,n.textContent="Stop",n.classList.add("stop-btn"),n.onclick=s=>{s.preventDefault(),B()})},400)))}function Y(){let e=document.getElementById("chatForm");e&&e.addEventListener("submit",t=>{t.preventDefault();let o=e.querySelector('input[name="message"]'),n=o.value.trim(),s=document.getElementById("selectedModel").value,i=document.getElementById("imageData").value;if(!n)return;X(!1),ee(n,!!i),o.value="",y(),te(n,s,i)})}window.removeImage=y;window.scrollToBottom=u;window.toggleSessionPanel=b;window.toggleNewChatForm=U;window.createNewSession=W;window.switchSession=T;window.deleteSession=$;window.toggleModelDropdown=I;window.selectModel=C;window.loadModels=x;window.toggleActivityBox=z;window.stopStreaming=B;document.body.addEventListener("htmx:afterSwap",()=>{u()});document.addEventListener("DOMContentLoaded",()=>{O(),Y(),q(),_(),J()});
//# sourceMappingURL=bundle.js.map
