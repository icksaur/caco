var ce=Object.defineProperty;var J=(e,t)=>()=>(e&&(t=e(e=0)),t);var de=(e,t)=>{for(var o in t)ce(e,o,{get:t[o],enumerable:!0})};function U(){return u.activeSessionId}function S(){return u.currentCwd}function _(){return u.selectedModel}function $(){return u.activeEventSource}function W(e,t){u.activeSessionId=e,u.currentCwd=t}function I(e){u.selectedModel=e;let t=document.getElementById("selectedModel");t&&(t.value=e)}function y(e,t=null){u.isStreaming=e,u.activeEventSource=t}function b(e){u.hasImage=e}function z(e){e.lastModel&&I(e.lastModel),e.lastCwd&&(u.currentCwd=e.lastCwd),e.lastSessionId!==void 0&&(u.activeSessionId=e.lastSessionId)}var le,u,w=J(()=>{"use strict";le="claude-sonnet-4",u={activeSessionId:null,currentCwd:"",selectedModel:le,isStreaming:!1,activeEventSource:null,hasImage:!1}});var X={};de(X,{applyModelPreference:()=>P,getNewChatCwd:()=>k,hideNewChat:()=>E,loadModels:()=>M,selectModel:()=>C,setAvailableModels:()=>N,showNewChat:()=>f,showNewChatError:()=>H});function N(e){D=e,console.log("[MODEL] Available models from SDK:",e.map(t=>t.id))}function A(){return D.length>0?D:me}function f(e){let t=document.getElementById("newChat"),o=document.getElementById("chat"),n=document.getElementById("newChatCwd"),s=document.getElementById("newChatError");t&&o&&(t.classList.remove("hidden"),o.classList.add("hidden"),s&&(s.textContent=""),n&&e&&(n.value=e),M())}function E(){let e=document.getElementById("newChat"),t=document.getElementById("chat");e&&t&&(e.classList.add("hidden"),t.classList.remove("hidden"))}function k(){return document.getElementById("newChatCwd")?.value.trim()||""}function H(e){let t=document.getElementById("newChatError");t&&(t.textContent=e)}function M(){let e=document.getElementById("modelList");if(!e)return;e.innerHTML="";let t=_(),o=A();for(let n of o){let s=document.createElement("div");s.className="model-item",n.id===t&&s.classList.add("active"),s.dataset.modelId=n.id,s.onclick=()=>C(n.id);let a=document.createElement("span");a.className="model-name",a.textContent=n.name,s.appendChild(a);let i=document.createElement("span");i.className="model-cost",n.cost===0?(i.textContent="free",i.classList.add("free")):n.cost<1?(i.textContent=`${n.cost}x`,i.classList.add("cheap")):n.cost>1?(i.textContent=`${n.cost}x`,i.classList.add("expensive")):i.textContent="1x",s.appendChild(i),e.appendChild(s)}}function C(e){I(e);let o=A().find(s=>s.id===e);if(o){let s=document.querySelector('input[name="message"]');s&&(s.placeholder=`Ask ${o.name}...`)}document.querySelectorAll(".model-item").forEach(s=>{s.dataset.modelId===e?s.classList.add("active"):s.classList.remove("active")}),fetch("/api/preferences",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lastModel:e})}).catch(()=>{})}function P(e){let t=A();if(e.lastModel&&t.find(o=>o.id===e.lastModel)){I(e.lastModel);let o=t.find(n=>n.id===e.lastModel);if(o){let n=document.querySelector('input[name="message"]');n&&(n.placeholder=`Ask ${o.name}...`)}}}var me,D,h=J(()=>{"use strict";w();me=[{id:"claude-sonnet-4",name:"Claude Sonnet 4",cost:1},{id:"claude-sonnet-4.5",name:"Claude Sonnet 4.5",cost:1},{id:"claude-opus-4.5",name:"Claude Opus 4.5",cost:3},{id:"claude-haiku-4.5",name:"Claude Haiku 4.5",cost:.33},{id:"gpt-4.1",name:"GPT-4.1",cost:0},{id:"gpt-4o",name:"GPT-4o",cost:0}],D=[]});w();function G(){document.addEventListener("paste",e=>{let t=e.clipboardData?.items;if(t)for(let o=0;o<t.length;o++){let n=t[o];if(n.type.indexOf("image")!==-1){e.preventDefault();let s=n.getAsFile();if(!s)continue;let a=new FileReader;a.onload=i=>{let d=i.target?.result,l=document.getElementById("imageData"),c=document.getElementById("previewImg"),r=document.getElementById("imagePreview");l&&(l.value=d),c&&(c.src=d),r&&r.classList.add("visible"),b(!0)},a.onerror=i=>console.error("FileReader error:",i),a.readAsDataURL(s);break}}})}function L(){let e=document.getElementById("imageData"),t=document.getElementById("previewImg"),o=document.getElementById("imagePreview");e&&(e.value=""),t&&(t.src=""),o&&o.classList.remove("visible"),b(!1)}function p(){let e=document.querySelector("main");e&&(e.scrollTop=e.scrollHeight)}function K(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>t[o])}function Q(e){if(!e)return"";let t=Date.now(),o=new Date(e).getTime(),n=t-o,s=Math.floor(n/6e4),a=Math.floor(n/36e5),i=Math.floor(n/864e5),d=Math.floor(i/7),l=Math.floor(i/30),c=Math.floor(i/365);return c>=1?`${c} year${c>1?"s":""}`:l>=1?`${l} month${l>1?"s":""}`:d>=1?`${d} week${d>1?"s":""}`:i>=1?`${i} day${i>1?"s":""}`:a>=1?`${a} hour${a>1?"s":""}`:s>=1?`${s} min`:"just now"}h();w();async function Y(){try{let e=await fetch("/api/history");if(e.ok){let t=await e.text(),o=document.getElementById("chat");o&&t.trim()?(o.innerHTML=t,E(),typeof window.renderMarkdown=="function"&&window.renderMarkdown(),p()):f()}else f()}catch(e){console.error("Failed to load history:",e),f()}}async function Z(){try{let e=await fetch("/api/preferences");if(e.ok){let t=await e.json();return z(t),P(t),t.lastSessionId!=null}}catch(e){console.error("Failed to load preferences:",e)}return!1}w();h();function ee(){let e=document.getElementById("chatView"),t=document.getElementById("sessionView"),o=document.getElementById("chatFooter"),n=document.getElementById("menuBtn");!e||!t||(e.classList.remove("active"),t.classList.add("active"),o?.classList.add("hidden"),n?.classList.add("active"),F())}function O(){let e=document.getElementById("chatView"),t=document.getElementById("sessionView"),o=document.getElementById("chatFooter"),n=document.getElementById("menuBtn");if(!e||!t)return;if(t.classList.contains("active")){t.classList.remove("active"),e.classList.add("active"),o?.classList.remove("hidden"),n?.classList.remove("active");let a=document.getElementById("chat");a&&a.children.length===0&&f(S())}else e.classList.remove("active"),t.classList.add("active"),o?.classList.add("hidden"),n?.classList.add("active"),F()}async function F(){try{let e=await fetch("/api/sessions");if(!e.ok)return;let t=await e.json(),{activeSessionId:o,currentCwd:n,grouped:s,models:a}=t;W(o,n),a&&a.length>0&&N(a);let i=document.getElementById("sessionList");if(!i)return;i.innerHTML="";let d=Object.keys(s).sort((l,c)=>l===n?-1:c===n?1:l.localeCompare(c));for(let l of d){let c=s[l];if(l==="(unknown)"||!l){let m=document.createElement("div");m.className="cwd-header omitted",m.textContent=`no cwd (${c.length} omitted)`,i.appendChild(m);continue}let r=document.createElement("div");r.className="cwd-header",r.textContent=l===n?`${l} (current)`:l,i.appendChild(r);for(let m of c){let v=ue(m,o);i.appendChild(v)}}}catch(e){console.error("Failed to load sessions:",e)}}function ue(e,t){let o=document.createElement("div");o.className="session-item",e.sessionId===t&&o.classList.add("active"),o.dataset.sessionId=e.sessionId;let n=document.createElement("span");n.className="session-summary";let s=e.summary||"No summary",a=e.updatedAt?` (${Q(e.updatedAt)})`:"";n.textContent=s+a,n.onclick=()=>j(e.sessionId),o.appendChild(n);let i=document.createElement("button");return i.className="session-delete",i.textContent="\xD7",i.onclick=d=>{d.stopPropagation(),q(e.sessionId,e.summary)},o.appendChild(i),o}async function j(e){if(e===U()){O(),p();return}let t=document.querySelector(`.session-item[data-session-id="${e}"]`);t&&t.classList.add("loading");try{let o=await fetch(`/api/sessions/${e}/resume`,{method:"POST"});if(o.ok)window.location.reload();else{let n=await o.json();t&&t.classList.remove("loading"),alert("Failed to switch session: "+n.error)}}catch(o){console.error("Failed to switch session:",o),t&&t.classList.remove("loading")}}async function q(e,t){let o=t||e.slice(0,8);if(confirm(`Delete session "${o}"?

This cannot be undone.`))try{let n=await fetch(`/api/sessions/${e}`,{method:"DELETE"});if(n.ok){if((await n.json()).wasActive){let a=document.getElementById("chat");a&&(a.innerHTML=""),f(S())}F()}else{let s=await n.json();alert("Failed to delete session: "+s.error)}}catch(n){console.error("Failed to delete session:",n),alert("Failed to delete session: "+n.message)}}function te(){let e=document.getElementById("chatView"),t=document.getElementById("sessionView"),o=document.getElementById("chatFooter"),n=document.getElementById("chat"),s=document.getElementById("menuBtn");e&&t&&(t.classList.remove("active"),e.classList.add("active"),o?.classList.remove("hidden"),s?.classList.remove("active"),n&&(n.innerHTML=""),f(S()),document.querySelector('form input[name="message"]')?.focus())}h();function g(e,t,o=null){let n=document.querySelector("#pending-response .activity-box");if(!n)return;let s=document.createElement("div");if(s.className=`activity-item ${e}`,o){let i=document.createElement("div");i.className="activity-summary",i.textContent=t,i.onclick=()=>s.classList.toggle("expanded"),s.appendChild(i);let d=document.createElement("div");d.className="activity-details",d.textContent=o,s.appendChild(d)}else s.textContent=t;n.appendChild(s);let a=n.closest(".activity-wrapper");if(a){let i=n.querySelectorAll(".activity-item").length,d=a.querySelector(".activity-count");d&&(d.textContent=`(${i})`)}n.scrollTop=n.scrollHeight}function ne(e){let t=e.closest(".activity-wrapper");if(!t)return;let o=t.classList.contains("collapsed");t.classList.toggle("collapsed");let n=e.querySelector(".activity-icon");n&&(n.textContent=o?"\u25BC":"\u25B6")}function oe(e){if(!e)return"";let t=[];for(let[o,n]of Object.entries(e))if(typeof n=="string"){let s=n.length>80?n.substring(0,80)+"...":n;t.push(`${o}: ${s}`)}else typeof n=="object"?t.push(`${o}: ${JSON.stringify(n).substring(0,60)}...`):t.push(`${o}: ${n}`);return t.join(", ")}function se(e){if(!e)return"";if(e.content){let t=typeof e.content=="string"?e.content:JSON.stringify(e.content);return t.length>500?t.substring(0,500)+"...":t}return JSON.stringify(e).substring(0,200)}async function ie(e){if(!e||!e.id)return;let t=document.querySelector("#pending-response .outputs-container");if(t)try{let o=await fetch(`/api/outputs/${e.id}?format=json`);if(!o.ok)return;let{data:n,metadata:s}=await o.json(),a="";if(e.type==="file"){let i=s.highlight||"",d=s.path?`**${s.path}**`:"",l=s.startLine&&s.endLine?` (lines ${s.startLine}-${s.endLine} of ${s.totalLines})`:"";a=`${d}${l}

\`\`\`${i}
${n}
\`\`\``}else if(e.type==="terminal"){let i=s.exitCode===0?"":` (exit ${s.exitCode})`;a=`\`\`\`bash
$ ${s.command}${i}
${n}
\`\`\``}else if(e.type==="image"){let i=document.createElement("img");i.className="output-image",i.src=s.mimeType&&typeof n=="string"?`data:${s.mimeType};base64,${n}`:`/api/outputs/${e.id}`,i.alt=s.path||"Image",t.appendChild(i);return}if(a&&window.marked&&window.DOMPurify){let i=document.createElement("div");i.className="output-content",i.innerHTML=window.DOMPurify.sanitize(window.marked.parse(a)),t.appendChild(i),i.querySelectorAll("pre code").forEach(d=>{window.hljs&&window.hljs.highlightElement(d)})}}catch(o){console.error("Error displaying output:",o)}}w();h();var x=null;function pe(e,t){let o=document.getElementById("chat");if(!o)throw new Error("Chat element not found");E();let n=document.createElement("div");n.className="message user",n.innerHTML=`${K(e)}${t?' <span class="image-indicator">[img]</span>':""}`,o.appendChild(n);let s=document.createElement("div");return s.className="message assistant pending",s.id="pending-response",s.setAttribute("data-markdown",""),s.innerHTML=`
    <div class="activity-wrapper">
      <div class="activity-header" onclick="toggleActivityBox(this)">
        <span class="activity-icon">\u25B6</span>
        <span class="activity-label">Activity</span>
        <span class="activity-count"></span>
      </div>
      <div class="activity-box"></div>
    </div>
    <div class="outputs-container"></div>
    <div class="markdown-content streaming-cursor"></div>
  `,o.appendChild(s),p(),s}function fe(e,t,o,n){let s=new URLSearchParams({prompt:e,model:t});o&&s.set("imageData",o),n&&s.set("cwd",n);let a=new EventSource(`/api/stream?${s.toString()}`);y(!0,a);let i=document.querySelector("#pending-response .markdown-content"),d="",l=!1;a.addEventListener("assistant.message_delta",c=>{let r=JSON.parse(c.data);if(r.deltaContent){if(d+=r.deltaContent,i&&(i.textContent=d),!l){let m=document.querySelector("#pending-response .activity-wrapper");if(m){m.classList.add("collapsed");let v=m.querySelector(".activity-icon");v&&(v.textContent="\u25B6")}l=!0}p()}}),a.addEventListener("assistant.message",c=>{let r=JSON.parse(c.data);if(r.content&&i){i.textContent=r.content,i.classList.remove("streaming-cursor");let m=document.getElementById("pending-response");m&&(m.dataset.markdownProcessed="false"),typeof window.renderMarkdown=="function"&&window.renderMarkdown()}}),a.addEventListener("assistant.turn_start",c=>{let r=JSON.parse(c.data);g("turn",`Turn ${parseInt(r.turnId||0)+1}...`)}),a.addEventListener("assistant.intent",c=>{let r=JSON.parse(c.data);r.intent&&g("intent",`Intent: ${r.intent}`)}),a.addEventListener("tool.execution_start",c=>{let r=JSON.parse(c.data),m=r.toolName||r.name||"tool",v=oe(r.arguments),B=`\u25B6 ${m}`,T=v?`Arguments: ${v}`:null;g("tool",B,T)}),a.addEventListener("tool.execution_complete",c=>{let r=JSON.parse(c.data),m=r.toolName||r.name||"tool",B=`${r.success?"\u2713":"\u2717"} ${m}`,T=r.result?se(r.result):null;g("tool-result",B,T),r._output&&ie(r._output)}),a.addEventListener("session.error",c=>{let r=JSON.parse(c.data);g("error",`Error: ${r.message||"Unknown error"}`)}),a.addEventListener("error",c=>{let r=JSON.parse(c.data||"{}");g("error",`Error: ${r.message||"Connection error"}`)}),a.addEventListener("done",()=>{a.close(),y(!1,null),R()}),a.addEventListener("session.idle",()=>{}),a.onerror=c=>{console.error("EventSource error:",c),a.close(),y(!1,null),!d&&!l&&g("error","Connection lost"),R()}}function V(){let e=$();if(e){e.close(),y(!1,null),g("info","Stopped by user");let t=document.querySelector("#pending-response .markdown-content");t&&t.classList.remove("streaming-cursor"),R()}}function R(){let e=document.getElementById("pending-response");if(e){e.classList.remove("pending"),e.removeAttribute("id");let t=e.querySelector(".markdown-content");t&&t.classList.remove("streaming-cursor");let o=e.querySelector(".activity-wrapper");if(o){o.classList.add("collapsed");let n=o.querySelector(".activity-icon");n&&(n.textContent="\u25B6")}}ae(!0)}function ae(e){let t=document.getElementById("chatForm"),o=t?.querySelector('input[name="message"]'),n=t?.querySelector('button[type="submit"]');!t||!o||!n||(x&&(clearTimeout(x),x=null),o.disabled=!e,e?(n.disabled=!1,n.textContent="Send",n.classList.remove("stop-btn"),n.onclick=null,o.focus()):(n.disabled=!0,n.textContent="Send",n.classList.remove("stop-btn"),x=setTimeout(()=>{$()&&(n.disabled=!1,n.textContent="Stop",n.classList.add("stop-btn"),n.onclick=s=>{s.preventDefault(),V()})},400)))}function re(){let e=document.getElementById("chatForm");e&&e.addEventListener("submit",t=>{t.preventDefault();let o=e.querySelector('input[name="message"]'),n=o.value.trim(),a=document.getElementById("selectedModel")?.value,i=document.getElementById("imageData").value,d=k(),l=document.getElementById("newChat");if(l&&!l.classList.contains("hidden")&&!d){H("Please enter a working directory");return}if(console.log("[MODEL] Client sending request with model:",a||"(undefined)"),d&&console.log("[CWD] New session cwd:",d),!n)return;ae(!1),pe(n,!!i),o.value="",L(),fe(n,a,i,d)})}window.removeImage=L;window.scrollToBottom=p;window.toggleSessionPanel=O;window.showNewChat=te;window.switchSession=j;window.deleteSession=q;window.selectModel=C;window.loadModels=M;window.toggleActivityBox=ne;window.stopStreaming=V;document.body.addEventListener("htmx:afterSwap",()=>{p()});document.addEventListener("DOMContentLoaded",async()=>{G(),re();try{let t=await fetch("/api/sessions");if(t.ok){let o=await t.json();if(o.models&&o.models.length>0){let{setAvailableModels:n}=await Promise.resolve().then(()=>(h(),X));n(o.models)}}}catch(t){console.error("Failed to fetch models on startup:",t)}await Z()?Y():ee()});
//# sourceMappingURL=bundle.js.map
